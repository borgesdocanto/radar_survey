<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radar Inmobiliario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root { --brand:#e54661; --bg:#0b0b0c; --panel:#121317; --line:#1f2330; --text:#f3f4f6; --muted:#9ca3af }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:22px auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;margin-bottom:16px}
    h1{font-size:22px;margin:0 0 6px;line-height:1.2}
    h2{font-size:16px;margin:8px 0 4px;color:var(--muted)}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:1.1fr .9fr}}
    .progress{width:100%;height:8px;background:#1f2330;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#7a1228,var(--brand))}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .kpi{display:flex;gap:16px;flex-wrap:wrap}
    .kpi .box{background:#121317;border:1px solid #1f2330;border-radius:12px;padding:12px 14px;min-width:120px}
    .footer{display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-top:12px}
    .btn{background:#1f2330;border:0;color:#e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--brand);color:#fff}
    input[type="text"]{padding:8px 10px;border-radius:8px;border:1px solid #333;background:#1f2330;color:#fff;width:100%;margin:8px 0 12px}
    label{display:block;margin-bottom:6px}
    .survey-q{font-size:18px;margin:0 0 8px}
    .survey-idx{color:var(--muted);font-size:12px;margin-bottom:8px}
    .slider{width:100%}
    .nums{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .nums button{flex:1 0 36px;min-width:36px;padding:8px 0;border:1px solid #333;background:#1f2330;color:#e5e7eb;border-radius:8px;cursor:pointer}
    .nums button.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .survey-nav{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;background:#171a21;border:1px solid #262a36;border-radius:999px;font-size:12px}
    .err{color:#ffb4b4;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="headerCard">
      <h1 id="title">Radar Inmobiliario</h1>
      <form id="nameForm">
        <label>Tu nombre completo
          <input type="text" id="fullName" required placeholder="Ej.: Leandro Borges Do Canto" />
        </label>
        <button type="submit" class="btn primary">Comenzar</button>
        <div class="err" id="nameErr" style="display:none">Ingresá tu nombre para continuar.</div>
      </form>
      <div class="muted" id="subtitle"></div>
    </div>

    <div class="card" id="surveyCard" style="display:none">
      <div class="survey-idx" id="qIdx">Pregunta 1/1</div>
      <div class="survey-q" id="qText">…</div>
      <input type="range" class="slider" id="qSlider" min="1" max="10" step="1" value="5" />
      <div class="nums" id="qNums"></div>
      <div class="survey-nav">
        <button class="btn" id="btnPrev" type="button">Anterior</button>
        <button class="btn primary" id="btnNext" type="button">Siguiente</button>
      </div>
    </div>

    <div class="grid" id="mainContent" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px">
          <span class="pill"><span>Modo</span><strong id="mode">visualización</strong></span>
          <button class="btn" id="btnCopy">Copiar URL del resultado</button>
        </div>
        <canvas id="radar" height="440"></canvas>
        <div class="footer">
          <div class="muted">Puntaje por eje (0–10). “Ideal” = máximo de cada pregunta normalizado a 10.</div>
        </div>
      </div>
      <div class="card">
        <h2>Resumen</h2>
        <div class="kpi" id="kpi"></div>
        <div style="height:8px"></div>
        <div class="progress"><div class="bar" id="overallBar" style="width:0%"></div></div>
        <div class="muted" id="overallText" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="card" id="questionsCard" style="display:none">
      <h2>Detalle de preguntas</h2>
      <table id="tbl">
        <thead>
          <tr><th>#</th><th>Pregunta</th><th>Resultado (A)</th><th>Máx (Q)</th><th>Normalizado (0–10)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const hasQS = !!qs.toString();
    function getSeq(prefix){ const out=[]; let i=1; while(qs.has(prefix+i)){ out.push(qs.get(prefix+i)); i++; } return out; }
    function toNum(x){ const n = Number(x); return Number.isFinite(n)? n : 0; }
    function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

    const defaultAxes = 'Captación de propiedades,Generación y gestión de leads,Productividad personal y del equipo,Conversión de operaciones';
    const axisNames = (qs.get('names') || defaultAxes).split(',').map(s=>s.trim()).filter(Boolean);
    const personFromQS = qs.get('name') || '';
    const forceSurvey = qs.get('survey') === '1';

    let T = getSeq('t');
    let A_fromQS = getSeq('A').map(toNum);
    let Q = getSeq('Q').map(q=> Number(q)||10);

    if(T.length === 0){
      T = [
        '¿Mi propuesta de captación comunica diferenciales y obtiene exclusivas?',
        '¿Prospecto Dueño Vende / referidos de forma constante?',
        '¿Mis tasaciones generan confianza (metodología, comparables, tiempos)?',
        '¿Mi % de exclusivas sobre captaciones es alto?',
        '¿Tengo fuentes estables de leads (ads, orgánico, referidos)?',
        '¿Ingreso cada lead al CRM con etiquetas y propietario?',
        '¿Respondo rápido con scripts claros en WhatsApp/IG/Email?',
        '¿Mido lead→cita y show rate semanalmente?',
        '¿Mi agenda cumple bloques de actividad de alto impacto?',
        '¿Equipo con checklists/playbooks para visitas, tasaciones y seguimiento?',
        '¿Automatizo comunicaciones claves (reseñas, recordatorios, post-visita)?',
        '¿Reviso KPI por agente y doy feedback accionable cada semana?',
        '¿Mis presentaciones y muestras generan confianza/urgencia sin presión?',
        '¿Gestiono objeciones de precio/condiciones con técnica?',
        '¿Tengo proceso claro de reserva a escritura sin fricciones?',
        '¿Mi tasa de cierre mejora mes a mes y la tengo medida?'
      ];
    }

    const N = T.length;
    if(Q.length < N){ Q = Q.concat(Array(N - Q.length).fill(10)); }
    if(A_fromQS.length > N){ A_fromQS = A_fromQS.slice(0,N); }

    const nameForm = document.getElementById('nameForm');
    const fullNameInput = document.getElementById('fullName');
    const nameErr = document.getElementById('nameErr');
    const headerCard = document.getElementById('headerCard');

    if(personFromQS){ fullNameInput.value = personFromQS; }

    nameForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = (fullNameInput.value || '').trim();
      if(!name){ nameErr.style.display='block'; return; }
      nameErr.style.display='none';

      // Insertar el nombre en la URL actual
      const params = new URLSearchParams(location.search);
      params.set('name', name);
      const newUrl = location.pathname + '?' + params.toString();
      history.replaceState(null, '', newUrl);

      const canDirect = (A_fromQS.length === N) && !forceSurvey;
      if(canDirect){ renderResults(name, A_fromQS); }
      else { startSurvey(name); }
    });

    const surveyCard = document.getElementById('surveyCard');
    const qIdxEl = document.getElementById('qIdx');
    const qTextEl = document.getElementById('qText');
    const qSlider = document.getElementById('qSlider');
    const qNums = document.getElementById('qNums');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');

    let answers = new Array(N).fill(5);
    let current = 0;

    function paintNumberButtons(){
      qNums.innerHTML = '';
      for(let n=1;n<=10;n++){
        const b = document.createElement('button');
        b.type='button'; b.textContent=String(n);
        if(n===answers[current]) b.classList.add('active');
        b.addEventListener('click',()=>{ answers[current]=n; qSlider.value = n; paintNumberButtons(); });
        qNums.appendChild(b);
      }
    }

    qSlider.addEventListener('input', ()=>{ answers[current]=Number(qSlider.value); paintNumberButtons(); });

    function showQuestion(){
      qIdxEl.textContent = `Pregunta ${current+1}/${N}`;
      qTextEl.textContent = T[current] || '';
      qSlider.value = clamp(answers[current],1,10);
      paintNumberButtons();
      btnPrev.style.visibility = current===0? 'hidden':'visible';
      btnNext.textContent = current===N-1? 'Finalizar':'Siguiente';
    }

    btnPrev.addEventListener('click', ()=>{ if(current>0){ current--; showQuestion(); }});
    btnNext.addEventListener('click', ()=>{
      if(current < N-1){ current++; showQuestion(); }
      else {
        const name = (fullNameInput.value || 'Participante').trim();
        renderResults(name, answers);
      }
    });

    function startSurvey(name){
      headerCard.style.display = 'none';
      surveyCard.style.display = 'block';
      for(let i=0;i<Math.min(A_fromQS.length,N);i++){
        const v = clamp(Math.round(A_fromQS[i]),1,10);
        if(v){ answers[i]=v; }
      }
      showQuestion();
    }

    const mainContent = document.getElementById('mainContent');
    const questionsCard = document.getElementById('questionsCard');
    const kpi = document.getElementById('kpi');
    const overallBar = document.getElementById('overallBar');
    const overallText = document.getElementById('overallText');
    const tbody = document.querySelector('#tbl tbody');

    function renderResults(name, A){
      const header = document.getElementById('title');
      header.textContent = `Radar Inmobiliario de ${name}`;
      headerCard.style.display = 'block';
      surveyCard.style.display = 'none';
      mainContent.style.display = 'grid';
      questionsCard.style.display = 'block';
      document.getElementById('mode').textContent = 'visualización';

      const norm = A.map((a,i)=> Math.max(0, Math.min(10, ( (Number(a)||0) / (Q[i]||10) )*10 )));

      const k = axisNames.length || 4; const base = Math.floor(N / k); const extra = N % k;
      const groups = []; let idx=0; for(let g=0; g<k; g++){ const size = base + (g<extra?1:0); groups.push({label: axisNames[g]||`Eje ${g+1}`, idxFrom: idx, idxTo: idx+size}); idx+=size; }
      const axisScores = groups.map(g=>{ const slice = norm.slice(g.idxFrom,g.idxTo); return slice.length? (slice.reduce((s,x)=>s+x,0)/slice.length) : 0; });
      const ideal = groups.map(()=>10);

      kpi.innerHTML = '';
      groups.forEach((g,i)=>{
        const div = document.createElement('div');
        div.className = 'box';
        div.innerHTML = `<div style=\"font-size:12px;color:var(--muted)\">${g.label}</div><div style=\"font-size:22px;font-weight:800\">${axisScores[i].toFixed(2)}</div>`;
        kpi.appendChild(div);
      });

      const global = norm.length? (norm.reduce((s,x)=>s+x,0)/norm.length) : 0;
      overallBar.style.width = (global*10)+'%';
